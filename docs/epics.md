# InfiniteQuill - Epic Breakdown

**作者:** BMad
**日期:** 2025-11-16
**项目级别:** 中级
**目标规模:** 增强型

---

## 概述

本文档提供了InfiniteQuill的完整史诗和故事分解，将架构决策文档中的需求分解为可实施的故事。

**动态文档说明:** 这是初始版本。在UX设计和架构工作流程之后，它将更新以添加交互和技术细节到故事中。

## 功能需求清单

基于架构决策文档，识别出5个核心功能需求：

- **FR1**: 修复主角名字生成错误 - 在生成小说主角名字时，有时会出现错误或不一致的名字
- **FR2**: 增强章节上下文连贯性 - 章节生成时只依赖大纲和蓝图，缺乏与之前章节的上下文联系
- **FR3**: 修复章节蓝图详细程度选项bug - 生成章节蓝图时，详细程度选项设置无效，需要默认为详细配置
- **FR4**: UI暗色模式角色列表颜色优化 - 暗色模式下角色列表选中项太亮，白底白字不符合夜间模式视觉体验
- **FR5**: 实现配置管理的无感自动保存 - 配置修改后需要自动应用并保存，无需用户手动操作

---

## FR覆盖图

### 史诗结构提案

基于自然分组，建议将5个功能需求组织为3个史诗：

1. **史诗1: 基础设施现代化** (Epic 1: Infrastructure Modernization)
   - 覆盖: FR5 (配置自动保存)
   - 价值: 建立现代化配置管理基础，为后续所有功能提供可靠的基础设施

2. **史诗2: UI/UX体验优化** (Epic 2: UI/UX Experience Optimization)
   - 覆盖: FR3 (移除详细程度选项) + FR4 (暗色模式优化)
   - 价值: 提升用户界面体验，简化操作流程，增强视觉一致性

3. **史诗3: AI生成质量增强** (Epic 3: AI Generation Quality Enhancement)
   - 覆盖: FR1 (名字生成修复) + FR2 (上下文连贯性)
   - 价值: 显著提升AI生成内容的质量和一致性，增强用户创作体验

### 建议排序

1. **史诗1 (基础设施)** → 为其他史诗提供配置管理基础
2. **史诗2 (UI/UX)** → 界面优化，为AI功能提供更好用户体验
3. **史诗3 (AI质量)** → 核心AI功能增强，依赖于稳定的基础设施

这种分组基于以下原则：
- **技术依赖关系**: 基础设施优先，确保其他功能有稳定基础
- **用户体验流程**: 先优化界面，再增强核心功能
- **开发风险**: 低风险的基础设施和UI改动优先，高风险的AI功能在后
- **价值交付**: 每个史诗都能独立交付用户价值

---

## 史诗1: 基础设施现代化

**目标**: 建立现代化配置管理基础，实现无感自动保存功能，为整个应用提供可靠的配置基础设施

### 故事1.1: 项目设置与基础设施初始化

**作为** 开发团队，
**我想要** 建立现代化的配置管理基础设施，
**以便** 为所有后续功能提供可靠的配置基础。

**验收标准:**

**Given** 现有的配置管理系统
**When** 实现自动保存功能时
**Then** 应该使用2秒延迟自动保存机制
**And** 应该提供清晰的保存状态反馈
**And** 应该处理边界情况（应用关闭时的保存）

**前提条件:** 无

**技术说明:**
- 使用PySide6的QTimer实现2秒延迟
- 在config_widget.py中添加变更监听机制
- 实现状态栏反馈系统
- 确保配置文件I/O在后台线程执行避免UI卡顿

---

### 故事1.2: 配置自动保存核心功能实现

**作为** 最终用户，
**我想要** 配置修改后自动保存，
**以便** 无需手动操作就能持久化我的设置。

**验收标准:**

**Given** 用户在配置界面修改了任何设置
**When** 停止修改2秒后
**Then** 配置应该自动保存到文件
**And** 状态栏应该显示"配置已自动保存"
**And** 重新打开应用后配置应该保持不变

**前提条件:** 故事1.1完成

**技术说明:**
- 监听所有配置控件的change事件
- 实现2秒延迟定时器避免频繁I/O
- 在config_manager.py中增强保存逻辑
- 确保错误处理和用户反馈

---

### 故事1.3: 自动保存状态反馈系统

**作为** 最终用户，
**我想要** 清楚地看到配置的保存状态，
**以便** 了解我的修改是否已成功保存。

**验收标准:**

**Given** 配置正在自动保存过程中
**When** 查看状态栏时
**Then** 应该显示"配置已更改，2秒后自动保存..."
**And** 保存成功后应显示"配置已自动保存"
**And** 保存失败时应显示"配置保存失败，请重试"

**前提条件:** 故事1.2完成

**技术说明:**
- 在status_bar.py中实现状态反馈方法
- 使用不同颜色表示不同状态（信息/成功/错误）
- 成功消息3秒后自动清除
- 错误消息保持显示直到下次操作

---

### 故事1.4: 配置保存边界情况处理

**作为** 最终用户，
**我想要** 即使在异常情况下也能确保配置保存，
**以便** 不会丢失我的重要设置。

**验收标准:**

**Given** 配置修改后应用即将关闭
**When** 应用关闭时
**Then** 应该立即触发自动保存
**And** 应该确保所有待保存的更改都已写入
**And** 不应该出现数据丢失

**前提条件:** 故事1.2完成

**技术说明:**
- 在config_widget.py的closeEvent中处理
- 检查是否有活动的保存定时器
- 立即执行保存操作再关闭应用
- 确保异常情况下也能正常保存

---

## 史诗2: UI/UX体验优化

**目标**: 简化用户界面，优化视觉体验，消除配置混乱，提升整体用户交互质量

### 故事2.1: 章节蓝图详细程度选项移除

**作为** 最终用户，
**我想要** 简化章节蓝图生成界面，
**以便** 无需选择详细程度就能获得最佳的生成质量。

**验收标准:**

**Given** 用户在章节蓝图生成界面
**When** 查看生成选项时
**Then** 不应该看到详细程度选择下拉框
**And** 所有蓝图生成应该自动使用详细模式
**And** 生成的蓝图应该具有足够的长度和质量

**前提条件:** 史诗1完成

**技术说明:**
- 从config_widget.py中移除详细程度选择控件
- 在blueprint.py中固定detail_level为"detailed"
- 清理配置文件中的详细程度设置
- 确保向后兼容性

---

### 故事2.2: 暗色主题角色列表样式修复

**作为** 使用暗色模式的用户，
**我想要** 角色列表的选中项有合适的颜色，
**以便** 在夜间模式下能够清晰地看到选中的角色。

**验收标准:**

**Given** 应用处于暗色模式
**When** 在角色管理器中选择角色时
**Then** 选中项背景应该为暗灰色(#3a3a3a)
**And** 文字应该为纯白色(#ffffff)
**And** 悬停时应该有视觉反馈(#4a4a4a)

**前提条件:** 故事2.1完成

**技术说明:**
- 修改ui_qt/styles/material_dark.qss文件
- 添加QListWidget::item:selected样式规则
- 确保符合WCAG AA对比度标准(4.5:1)
- 测试与其他暗色主题元素的协调性

---

### 故事2.3: UI主题一致性验证

**作为** 最终用户，
**我想要** 所有UI元素在主题切换时保持一致，
**以便** 获得统一的视觉体验。

**验收标准:**

**Given** 应用切换浅色和暗色主题
**When** 查看所有UI组件时
**Then** 所有组件应该正确应用主题样式
**And** 角色列表的颜色应该与整体主题协调
**And** 不应该有样式冲突或视觉异常

**前提条件:** 故事2.2完成

**技术说明:**
- 验证theme_manager.py正确加载样式
- 测试role_manager.py中的控件类型(QListWidget或QTableView)
- 确保QSS样式规则覆盖所有相关控件
- 进行视觉回归测试

---

## 史诗3: AI生成质量增强

**目标**: 显著提升AI生成内容的质量和一致性，修复名字生成错误，增强章节间的上下文连贯性

### 故事3.1: 主角名字生成错误修复

**作为** 小说创作者，
**我想要** AI生成的主角名字准确且一致，
**以便** 我的小说角色有可信赖的标识。

**验收标准:**

**Given** 为小说生成主角名字时
**When** AI生成角色名字
**Then** 生成的名字应该合理且符合角色特征
**And** 不应该出现乱码或不一致的名称
**And** 名字应该在整个小说中保持一致

**前提条件:** 史诗2完成

**技术说明:**
- 审查prompt_definitions.py中的角色生成提示词
- 在novel_generator/chapter.py中添加名字验证逻辑
- 如有必要，增强consistency_checker.py验证角色名字连贯性
- 使用正则表达式验证名字合理性

---

### 故事3.2: 章节上下文检索系统实现

**作为** 小说创作者，
**我想要** 新生成的章节与之前章节保持上下文连贯，
**以便** 我的小说故事情节自然流畅。

**验收标准:**

**Given** 生成第N章内容时(N>1)
**When** AI检索前章节上下文时
**Then** 应该自动检索第N-1章的关键内容
**And** 应该通过向量相似度找到最相关的段落
**And** 应该将前章节摘要作为上下文添加到提示词

**前提条件:** 故事3.1完成

**技术说明:**
- 使用ChromaDB的metadata过滤确保检索相关章节
- 使用sentence-transformers生成章节摘要向量
- 设置上下文token限制(max_context_tokens=2000)
- 动态调整检索段落数(k值)

---

### 故事3.3: 跨章节连贯性验证

**作为** 小说创作者，
**我想要** 验证多章节生成的连贯性，
**以便** 确保我的小说质量达到预期。

**验收标准:**

**Given** 生成包含多个章节的小说时
**When** 检查章节间的连贯性时
**Then** 新章节应该自然延续前章节的情节
**And** 角色名字和特征应该保持一致
**And** 故事背景和设定应该连贯

**前提条件:** 故事3.2完成

**技术说明:**
- 实现连贯性检查逻辑
- 验证角色一致性
- 检查情节连续性
- 提供质量评估指标

---

## FR覆盖矩阵

| 功能需求 | 描述 | 覆盖史诗 | 覆盖故事 |
|---------|------|----------|----------|
| FR1 | 修复主角名字生成错误 | 史诗3: AI生成质量增强 | 故事3.1 |
| FR2 | 增强章节上下文连贯性 | 史诗3: AI生成质量增强 | 故事3.2, 3.3 |
| FR3 | 修复章节蓝图详细程度选项bug | 史诗2: UI/UX体验优化 | 故事2.1 |
| FR4 | UI暗色模式角色列表颜色优化 | 史诗2: UI/UX体验优化 | 故事2.2, 2.3 |
| FR5 | 实现配置管理的无感自动保存 | 史诗1: 基础设施现代化 | 故事1.1-1.4 |

**验证结果:** ✅ 所有5个FR都已完全覆盖

---

## 史诗分解总结

### 交付价值

**史诗1 (基础设施)** 提供了现代化配置管理基础，确保用户体验流畅无中断

**史诗2 (UI/UX)** 简化了用户界面，优化了视觉体验，特别是在暗色模式下的可用性

**史诗3 (AI质量)** 显著提升了AI生成内容的质量和一致性，这是应用的核心价值

### 技术影响

- **配置管理**: 从手动保存升级到自动保存，提升用户体验
- **UI一致性**: 修复主题不一致问题，增强视觉体验
- **AI生成**: 增强上下文连贯性，提升内容质量

### 开发顺序逻辑

1. **基础设施优先**: 确保其他功能有稳定的配置基础
2. **UI优化其次**: 为AI功能提供更好的用户界面
3. **AI质量最后**: 在稳定基础上提升核心功能

### 风险缓解

- **渐进式交付**: 每个史诗都能独立交付价值
- **向后兼容**: 所有改动都保持向后兼容性
- **测试覆盖**: 每个故事都有明确的测试策略

### BMad Method 下一步

此史诗分解是**初始版本**。后续工作流程将更新此文档：

1. **UX设计工作流程** (可选) - 将为涉及用户交互的故事添加详细的交互规范
2. **架构工作流程** - 将为每个故事添加具体的技术实现细节和架构决策
3. **阶段4实施** - 每个故事将从此文档中提取上下文进行实施

**准备确认:**

- ✅ 史诗结构合理，基于自然分组
- ✅ 所有FR都已完全覆盖并映射到具体故事
- ✅ 故事分解具有详细的验收标准，可执行实施
- ✅ 已准备好进入UX设计工作流程 (如果需要)

**重要:** 这是一个动态文档，将在工作流程链中随着UX和架构输入而演进。epics.md文件将在实施开始前整合UX和架构的输入。