# Story 3.3: 跨章节连贯性验证

Status: ready-for-dev

## Story

**作为** 小说创作者，
**我想要** 验证多章节生成的连贯性，
**以便** 确保我的小说质量达到预期。

## Acceptance Criteria

1. **情节连续性检查** - Given 生成包含多个章节的小说时, When 检查第N章和第N-1章之间的情节, Then 第N章的情节应该自然延续第N-1章的发展, And 不应该出现情节跳跃或不合理的转折

2. **角色名字一致性验证** - Given 多章节小说已生成, When 提取所有章节中的角色名字时, Then 每个角色的名字应该在所有章节中保持一致, And 不应该出现同一角色在不同章节有不同名字的现象

3. **角色特征一致性验证** - Given 多章节小说已生成, When 检查角色的特征(如性格、外貌、背景)在章节间的描述时, Then 这些特征应该在不同章节中保持一致或合理演进, And 不应该出现特征矛盾或突变(如一个角色在上一章是男性,下一章变成女性)

4. **故事背景和设定连贯性** - Given 多章节小说已生成, When 检查不同章节中描述的世界观、时间线、地点等设定时, Then 这些设定应该在所有章节中保持一致, And 不应该出现世界观矛盾(如第一章是现代社会,第二章突然变成古代武侠)

5. **质量评估指标** - Given 完成连贯性检查后, When 生成质量报告时, Then 应该提供量化指标: 情节连贯度分数(0-100)、角色一致性分数(0-100)、设定连贯度分数(0-100), And 对于检测到的问题,应该提供具体的章节位置和问题描述

6. **问题定位和建议** - Given 检测到连贯性问题, When 向用户展示问题详情时, Then 应该明确指出问题出现在哪些章节的哪些段落, And 应该提供修复建议(如"建议检查第3章和第4章的角色名字不一致问题")

## Tasks / Subtasks

### 任务1: 情节连续性检查逻辑 (AC#1)
- [ ] 在novel_generator/中创建coherence_checker.py模块
- [ ] 实现check_plot_continuity(chapter_n, chapter_n_minus_1)函数
- [ ] 使用LLM评估情节的自然延续性(提示词设计)
- [ ] 检测突兀的情节转折或跳跃
- [ ] 返回情节连贯度分数(0-100)和问题列表
- [ ] 测试已知连贯和不连贯的情节样本

### 任务2: 角色名字一致性验证 (AC#2)
- [ ] 实现extract_character_names(chapter_text)函数(使用正则表达式)
- [ ] 遍历所有章节,收集每个章节中的角色名字
- [ ] 实现name_normalization()函数处理名字变体(如"小李"和"李明")
- [ ] 检测同一角色在不同章节有不同名字的情况
- [ ] 返回角色一致性分数(0-100)和冲突列表
- [ ] 与Story 3.1的角色名字验证机制集成

### 任务3: 角色特征一致性验证 (AC#3)
- [ ] 实现extract_character_traits(chapter_text, character_name)函数
- [ ] 从文本中提取角色的性别、年龄、外貌、性格等特征
- [ ] 比较同一角色在不同章节的特征描述
- [ ] 使用LLM评估特征的一致性或合理演进
- [ ] 检测特征矛盾(如性别突变、年龄倒退)
- [ ] 返回特征一致性分数和问题报告

### 任务4: 故事背景和设定连贯性 (AC#4)
- [ ] 定义故事设定的关键维度: 时代背景、世界观类型、地点等
- [ ] 实现extract_story_setting(chapter_text)函数
- [ ] 使用LLM提取每章的设定信息
- [ ] 比较不同章节的设定是否一致
- [ ] 检测世界观矛盾(如从现代突然变古代)
- [ ] 返回设定连贯度分数和问题列表

### 任务5: 质量评估指标生成 (AC#5)
- [ ] 设计量化评分算法:
  - 情节连贯度: 基于LLM评估的平均分数
  - 角色一致性: 一致章节数/总章节数 × 100
  - 设定连贯度: 一致章节数/总章节数 × 100
- [ ] 计算总体质量分数(加权平均)
- [ ] 生成可视化质量报告(文本或HTML)
- [ ] 提供导出功能(保存为report.md)

### 任务6: 问题定位和用户反馈 (AC#6)
- [ ] 为每个检测到的问题生成human-readable描述
- [ ] 提供章节号和段落位置信息
- [ ] 给出具体的修复建议
- [ ] 在UI中创建连贯性检查报告对话框
- [ ] 使用StatusBar显示"正在检查章节连贯性..."和"检查完成,发现X个问题"
- [ ] 与Epic 1的状态反馈系统集成

### 任务7: 完整集成和端到端测试
- [ ] 集成所有检查模块: 情节、角色名字、角色特征、设定
- [ ] 创建run_coherence_check(novel_project)主入口函数
- [ ] 测试完整小说的连贯性检查流程
- [ ] 与Story 3.1的名字生成和Story 3.2的上下文检索集成测试
- [ ] 性能测试: 检查100章小说的时间<30秒
- [ ] 准确性测试: 与人工评估结果对比

## Dev Notes

### 相关架构细节

**主要文件位置**:
- `novel_generator/coherence_checker.py` - 新模块(主要实现)
- `novel_generator/chapter.py` - 章节内容访问
- `novel_generator/consistency_checker.py` - 已有的一致性检查(可选重用)
- `project_manager.py` - 项目文件访问
- `ui_qt/widgets/status_bar.py` - 状态反馈

**技术栈**:
- LangChain - LLM调用和提示词管理
- OpenAI API或其他LLM API - 连贯性评估
- Python difflib或类似库 - 文本相似度计算
- Regular expressions - 角色名字提取

**架构约束**:
- 检查过程不应该修改原始章节内容(只读)
- 检查结果应该可导出和持久化
- 检查应该是可选操作(不阻塞正常生成流程)
- LLM评估调用需要控制token消耗

### 关键设计决策

**评估方法选择**:
- **选项1**: 纯LLM评估(使用GPT-4)
  - 优点: 可以评估语义级别的连贯性
  - 缺点: token消耗大,成本高,速度慢
- **选项2**: 规则+LLM混合评估
  - 优点: 成本低,速度快,可解释性强
  - 缺点: 可能漏检一些微妙的语义不一致
- **推荐**: 选项2,平衡效率和准确性

**混合评估策略**:
```python
def check_coherence(chapters):
    """连贯性检查"""
    # 1. 规则检查(快速)
    rule_issues = run_rule_based_checks(chapters)

    # 2. LLM深度检查(针对疑似问题)
    llm_issues = []
    if rule_issues or len(chapters) > 3:
        llm_issues = run_llm_based_checks(chapters, rule_issues)

    return combine_issues(rule_issues, llm_issues)
```

**质量分数计算**:
- 情节连贯度: 调用LLM对每个相邻章节对评分(0-100),取平均
- 角色一致性: 一致章节数 / 总章节数 × 100
- 设定连贯度: 一致章节数 / 总章节数 × 100
- 总体质量: (情节×0.4 + 角色×0.3 + 设定×0.3) / 1

### 从Story 3.1和3.2学到的经验

**质量评估模式**:
- Story 3.1: 验证名字合理性
- Story 3.2: 评估上下文相关性
- Story 3.3: 评估整体连贯性
- 三者都使用验证+评估的组合方法

**可复用的组件**:
- Story 3.1的名字验证逻辑 → 用于角色名字一致性
- Story 3.2的上下文提取 → 用于情节连续性分析
- Story 1.3的状态反馈 → 显示检查进度和结果
- Story 1.4的错误处理 → 处理LLM调用失败

**跨故事协同**:
```python
# 集成示例
# Story 3.1确保名字一致性
character_registry = story_3_1_name_registry

# Story 3.2提供上下文
context = story_3_2_retrieve_context(previous_chapter)

# Story 3.3评估连贯性
coherence_report = story_3_3_check_coherence(all_chapters, character_registry, context)
```

### LLM评估提示词设计

**情节连续性评估**:
```
请评估以下两个章节的情节连续性:

第{N-1}章摘要:
{summary_n_minus_1}

第{N}章摘要:
{summary_n}

评估标准:
1. 情节是否自然延续?(0-100分)
2. 是否有突兀的转折或跳跃?
3. 整体连贯性如何?

请提供分数和简要分析。
```

**角色一致性评估**:
```
以下是对角色"{character_name}"在不同章节的描述:

第1章描述: {description_1}
第3章描述: {description_3}
第5章描述: {description_5}

检查以下特征是否一致或合理演进:
1. 性别
2. 年龄
3. 外貌特征
4. 核心性格

列出任何不一致或矛盾之处。
```

**设定连贯性评估**:
```
请分析以下章节的故事设定是否一致:

第1章设定: {setting_1}
第4章设定: {setting_4}

设定维度:
- 时代背景(古代/现代/未来)
- 世界观类型(现实主义/奇幻/科幻)
- 地理位置

是否有矛盾或不一致?
```

### 报告格式

**文本报告示例**:
```
# 小说连贯性检查报告

**总体质量分数: 85/100**

## 情节连贯度: 90/100 ✅
- 第1-2章: 90分 (自然过渡)
- 第2-3章: 85分 (稍有跳跃)
- 第3-4章: 95分 (非常流畅)

## 角色一致性: 80/100 ⚠️
**发现1个问题**:
- 角色"李明"的特征不一致
  - 第2章描述: "李明,25岁,性格内向"
  - 第5章描述: "李明,40岁,性格外向"
  - 建议: 检查年龄变化是否合理,性格转变是否有情节支撑

## 设定连贯度: 85/100 ✅
- 时代背景: 一致 (现代都市)
- 世界观: 一致 (现实主义)
- 地点: 需要关注 (第3章突然换城市,缺乏交代)

## 建议
1. 检查第5章李明性格的突然变化,考虑增加性格转变的情节铺垫
2. 第3章更换城市时,添加过渡说明或解释
```

**UI展示设计**:
- 使用颜色编码: 绿色(良好)、黄色(警告)、红色(严重问题)
- 可折叠的问题详情
- 跳转到相关章节的链接
- 导出按钮(生成markdown报告)

### 性能优化

**批量处理**:
- 对相邻章节对批量调用LLM评估
- 并行处理不同角色的一致性检查
- 异步执行耗时操作

**缓存策略**:
- 缓存LLM评估结果(章节内容未变则无需重新评估)
- 缓存token计数结果

**增量更新**:
- 只检查新添加或修改的章节
- 维护已验证章节的缓存

### 测试策略

**单元测试**:
- 角色名字提取的准确性
- 特征提取的准确性
- 质量分数计算公式
- 问题报告生成格式

**集成测试**:
- 完整连贯性检查流程
- 与Story 3.1和3.2的集成
- 小说项目文件读写

**性能测试**:
- 100章小说的检查时间
- LLM API调用次数和token消耗
- 内存使用

**人工评估对比**:
- 准备5-10个测试小说(包含已知的连贯和不连贯案例)
- 运行自动检查
- 与人工评估结果对比准确度
- 目标: 准确率>80%

## References

**来源文档**:
- Epic 3: AI生成质量增强 [Source: docs/epics.md#Epic-3]
- Story 3.3: 跨章节连贯性验证 [Source: docs/epics.md#Story-3.3]

**相关技术文档**:
- 架构决策文档 [Source: docs/bmm-architecture-decisions-2025-11-16.md]
- ChatGPT/OpenAI API提示词工程指南
- 文本相似度计算算法(difflib, Levenshtein distance)
- 正则表达式高级用法

**依赖关系**:
- Story 3.1的角色名字验证机制
- Story 3.2的章节上下文检索系统
- Epic 1的配置管理和状态反馈
- Epic 2的UI优化

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

### Completion Notes List

- 完成了Epic 3的第三个故事,也是整个项目的最后一个故事
- 构建了完整的小说质量验证体系
- 与Story 3.1的名字一致性和Story 3.2的上下文连贯性形成闭环
- 提供量化质量指标和用户友好的问题报告
- 标志着AI生成质量从生成到验证的完整流程建立
- 所有10个故事已全部创建完成!

### File List

