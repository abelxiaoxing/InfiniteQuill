<story-context id="1-2-config-auto-save-core-functionality" v="1.0">
  <metadata>
    <epicId>epic-1</epicId>
    <storyId>1-2</storyId>
    <title>配置自动保存核心功能实现</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-config-auto-save-core-functionality.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>最终用户</asA>
    <iWant>配置修改后自动保存</iWant>
    <soThat>无需手动操作就能持久化我的设置</soThat>
    <tasks>
      <task id="1">在config_widget.py中添加所有配置控件的change事件监听</task>
      <task id="2">实现2秒延迟定时器(QTimer)</task>
      <task id="3">每次变更时重置定时器以避免频繁I/O</task>
      <task id="4">测试定时器触发逻辑</task>
      <task id="5">在config_widget.py中实现auto_save_config()方法</task>
      <task id="6">调用config_manager.save_config()执行实际保存</task>
      <task id="7">实现配置变更收集和序列化</task>
      <task id="8">测试配置文件的写入和读取正确性</task>
      <task id="9">验证应用重启后配置持久化</task>
      <task id="10">调用status_bar.set_success_state()显示保存成功</task>
      <task id="11">实现3秒后自动清除成功消息</task>
      <task id="12">调用status_bar.set_error_state()显示保存错误</task>
      <task id="13">集成错误日志记录(logging.error)</task>
      <task id="14">实现try-except错误捕获</task>
      <task id="15">处理文件权限错误</task>
      <task id="16">处理磁盘空间不足错误</task>
      <task id="17">处理配置文件损坏错误</task>
      <task id="18">实现优雅降级(使用默认值)</task>
      <task id="19">测试单次配置变更自动保存</task>
      <task id="20">测试快速连续多次配置变更(批量保存)</task>
      <task id="21">测试2秒延迟准确性</task>
      <task id="22">测试错误场景和错误消息</task>
      <task id="23">测试配置文件持久化可靠性</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">配置自动保存触发 - Given 用户在配置界面修改了任何设置, When 停止修改操作后, Then 2秒延迟后应该触发自动保存机制</criterion>
    <criterion id="2">配置文件持久化 - Given 自动保存机制触发, When 保存配置到文件时, Then 配置应该正确写入config.json文件</criterion>
    <criterion id="3">保存状态反馈 - Given 配置自动保存完成, When 查看状态栏时, Then 应该显示"配置已自动保存"成功消息</criterion>
    <criterion id="4">持久化验证 - Given 配置已自动保存, When 重新打开应用时, Then 之前的配置修改应该仍然有效且保持不变</criterion>
    <criterion id="5">错误处理 - Given 自动保存过程中发生错误, When 检测错误时, Then 应该记录错误日志并显示"配置保存失败，请重试"错误消息</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc name="epics.md" path="docs/epics.md" section="史诗1: 基础设施现代化">包含史诗1的完整故事分解</doc>
      <doc name="architecture-decisions" path="docs/bmm-architecture-decisions-2025-11-16.md" section="需求5: 配置管理无感（自动保存）">详细的架构决策和实现指导</doc>
      <doc name="component-inventory" path="docs/component-inventory.md">系统组件清单</doc>
      <doc name="development-guide" path="docs/development-guide.md">开发指南和模式</doc>
      <doc name="architecture" path="docs/architecture.md">系统架构文档</doc>
    </docs>

    <code>
      <file name="config_widget.py" path="ui_qt/widgets/config_widget.py">
        <class name="ConfigWidget">
          <method name="__init__">初始化配置管理界面</method>
          <method name="setup_ui">设置UI布局</method>
          <method name="load_current_config">加载当前配置到界面</method>
          <method name="update_config_from_ui">从界面更新配置</method>
          <method name="apply_config">应用配置</method>
          <method name="save_config">保存配置</method>
          <method name="on_config_selected">配置选择变更处理</method>
          <method name="on_proxy_state_changed">代理状态变更处理</method>
          <signal name="config_changed">配置变更信号</signal>
        </class>
        <snippet name="auto_save_timer_pattern">
# 定时器使用模式
self.save_timer = QTimer()
self.save_timer.setInterval(2000)  # 2秒延迟
self.save_timer.setSingleShot(True)
self.save_timer.timeout.connect(self.auto_save_config)
        </snippet>
        <snippet name="change_listener_pattern">
# 变更监听模式
def on_config_changed(self, key, value):
    self.config[key] = value
    self.save_timer.stop()
    self.save_timer.start()
        </snippet>
      </file>

      <file name="status_bar.py" path="ui_qt/widgets/status_bar.py">
        <class name="StatusBar">
          <method name="show_message">显示状态消息</method>
          <method name="set_error_state">设置错误状态</method>
          <method name="set_warning_state">设置警告状态</method>
          <method name="set_success_state">设置成功状态</method>
          <method name="clear_message">清除状态消息</method>
          <method name="update_time">更新时间显示</method>
        </class>
        <snippet name="success_state_usage">
# 显示成功状态
status_bar.set_success_state("配置已自动保存")
# 3秒后自动清除
        </snippet>
        <snippet name="error_state_usage">
# 显示错误状态
status_bar.set_error_state("配置保存失败，请重试")
        </snippet>
      </file>

      <file name="config_manager.py" path="config_manager.py">
        <function name="save_config">保存配置到文件</function>
        <function name="load_config">从文件加载配置</function>
        <function name="get_user_config_path">获取用户配置文件路径</function>
        <function name="get_config_directory">获取跨平台配置目录</function>
        <function name="create_config">创建默认配置文件</function>
      </file>
    </code>

    <dependencies>
      <package name="PySide6" version="6.8.0">Qt框架 - QTimer用于实现2秒延迟自动保存</package>
      <package name="PySide6-Addons" version="6.8.0">Qt附加组件</package>
      <package name="langchain" version="0.3.27">AI集成框架</package>
      <package name="openai" version="1.106.1">OpenAI API</package>
      <package name="chromadb" version="1.0.20">向量数据库</package>
      <package name="sentence-transformers" version="5.1.0">文本嵌入模型</package>
      <package name="coloredlogs" version="15.0.1">日志记录</package>
      <package name="rich" version="14.1.0">日志格式化</package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint name="架构约束">必须遵循Story 1.1建立的基础设施模式</constraint>
    <constraint name="存储位置">配置文件存储在跨平台用户配置目录</constraint>
    <constraint name="向后兼容">保持向后兼容现有配置格式</constraint>
    <constraint name="错误处理">遵循错误处理统一模式</constraint>
    <constraint name="延迟机制">使用2秒延迟避免频繁I/O操作</constraint>
    <constraint name="单触发定时器">使用setSingleShot(True)确保每次变更只保存一次</constraint>
    <constraint name="错误恢复">实现优雅降级，保留内存配置，下次重试</constraint>
    <constraint name="状态反馈">成功消息3秒后自动清除，错误消息保持显示</constraint>
  </constraints>

  <interfaces>
    <interface name="QTimer" type="PySide6.QtCore">用于实现2秒延迟自动保存机制</interface>
    <interface name="QStatusBar" type="PySide6.QtWidgets">状态栏组件，提供状态反馈</interface>
    <interface name="save_config" type="function">config_manager.py中的配置保存函数</interface>
    <interface name="config_changed" type="signal">ConfigWidget发出的配置变更信号</interface>
    <interface name="set_success_state" type="method">status_bar.py中的成功状态显示方法</interface>
    <interface name="set_error_state" type="method">status_bar.py中的错误状态显示方法</interface>
  </interfaces>

  <tests>
    <standards>
      <standard name="错误处理模式">使用try-except-finally模式，记录日志并显示用户友好的错误消息</standard>
      <standard name="日志记录模式">使用标准logging模块，区分INFO/DEBUG/WARNING/ERROR级别</standard>
      <standard name="状态反馈模式">成功消息3秒后自动清除，错误消息保持显示直到下次操作</standard>
      <standard name="性能测试">验证自动保存过程中UI响应性，不应出现卡顿</standard>
      <standard name="边界测试">测试应用关闭时的数据保存完整性</standard>
      <standard name="延迟准确性">测试2秒延迟的准确性，允许±100ms误差</standard>
      <standard name="批量保存测试">测试快速连续多次配置变更的批量保存行为</standard>
    </standards>

    <locations>
      <location>ui_qt/widgets/config_widget.py - 自动保存核心逻辑</location>
      <location>ui_qt/widgets/status_bar.py - 状态反馈接口</location>
      <location>config_manager.py - 配置保存逻辑</location>
    </locations>

    <ideas>
      <idea name="单元测试">为自动保存机制编写单元测试，验证2秒延迟逻辑</idea>
      <idea name="集成测试">测试配置变更到状态反馈的完整流程</idea>
      <idea name="边界测试">测试应用关闭时自动保存的数据完整性</idea>
      <idea name="性能测试">验证后台线程I/O操作不阻塞UI</idea>
      <idea name="错误测试">测试保存失败时的错误处理和用户反馈</idea>
      <idea name="延迟测试">测试2秒延迟的准确性和稳定性</idea>
      <idea name="批量测试">测试快速连续配置变更的处理</idea>
      <idea name="持久化测试">验证应用重启后配置恢复的正确性</idea>
    </ideas>
  </tests>
</story-context>