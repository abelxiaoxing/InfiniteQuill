<story-context id="1-3-auto-save-status-feedback-system" v="1.0">
  <metadata>
    <epicId>epic-1</epicId>
    <storyId>1-3</storyId>
    <title>自动保存状态反馈系统</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-auto-save-status-feedback-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>最终用户</asA>
    <iWant>清楚地看到配置的保存状态</iWant>
    <soThat>了解我的修改是否已成功保存</soThat>
    <tasks>
      <task id="1">在status_bar.py中实现set_info_state()方法(灰色, 信息图标)</task>
      <task id="2">在status_bar.py中实现set_success_state()方法(绿色, 成功图标)</task>
      <task id="3">在status_bar.py中实现set_error_state()方法(红色, 错误图标)</task>
      <task id="4">确保所有方法接受消息字符串参数</task>
      <task id="5">实现clear_status()方法清除当前状态</task>
      <task id="6">成功消息使用QTimer实现3秒后自动清除</task>
      <task id="7">错误消息保持显示直到下次状态变更</task>
      <task id="8">待保存消息在定时器重置时更新或清除</task>
      <task id="9">定义信息状态颜色: 背景#e3f2fd, 文字#1976d2</task>
      <task id="10">定义成功状态颜色: 背景#e8f5e9, 文字#2e7d32</task>
      <task id="11">定义错误状态颜色: 背景#ffebee, 文字#c62828</task>
      <task id="12">确保颜色符合Material Design规范</task>
      <task id="13">测试颜色对比度和可访问性</task>
      <task id="14">在config_widget.py中调用status_bar.set_info_state()显示待保存</task>
      <task id="15">在自动保存成功时调用status_bar.set_success_state()</task>
      <task id="16">在自动保存失败时调用status_bar.set_error_state()</task>
      <task id="17">在定时器重置时清除或更新待保存状态</task>
      <task id="18">测试完整的自动保存→状态反馈流程</task>
      <task id="19">单元测试每个状态方法(set_info/success/error)</task>
      <task id="20">测试3秒自动清除功能</task>
      <task id="21">测试错误消息持久化显示</task>
      <task id="22">测试状态消息队列管理</task>
      <task id="23">集成测试: 完整的配置修改→自动保存→状态反馈流程</task>
      <task id="24">验证颜色方案在不同主题下的显示效果</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">待保存状态显示 - Given 配置正在等待自动保存, When 查看状态栏时, Then 应该显示"配置已更改，2秒后自动保存..."信息状态消息</criterion>
    <criterion id="2">保存成功状态显示 - Given 配置自动保存成功完成, When 查看状态栏时, Then 应该显示"配置已自动保存"成功消息, And 消息应该在3秒后自动清除</criterion>
    <criterion id="3">保存失败状态显示 - Given 配置自动保存过程中发生错误, When 检测错误时, Then 应该显示"配置保存失败，请重试"错误消息, And 错误消息应该保持显示直到用户操作</criterion>
    <criterion id="4">状态颜色编码 - Given 状态消息正在显示, When 查看状态栏颜色时, Then 待保存状态应该为信息色(灰色), And 成功状态应该为成功色(绿色), And 错误状态应该为错误色(红色)</criterion>
    <criterion id="5">状态消息队列管理 - Given 多个状态需要显示, When 新状态消息触发时, Then 应该按顺序显示, And 不应该丢失重要状态消息</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc name="epics.md" path="docs/epics.md" section="史诗1: 基础设施现代化">包含史诗1的完整故事分解</doc>
      <doc name="architecture-decisions" path="docs/bmm-architecture-decisions-2025-11-16.md" section="需求5: 配置管理无感（自动保存）">详细的架构决策和实现指导</doc>
      <doc name="component-inventory" path="docs/component-inventory.md">系统组件清单</doc>
      <doc name="development-guide" path="docs/development-guide.md">开发指南和模式</doc>
      <doc name="story-1-1-context" path="docs/sprint-artifacts/stories/1-1-project-setup-and-infrastructure-initialization.context.xml">基础设施初始化上下文</doc>
      <doc name="story-1-2-context" path="docs/sprint-artifacts/stories/1-2-config-auto-save-core-functionality.context.xml">自动保存核心功能上下文</doc>
    </docs>

    <code>
      <file name="status_bar.py" path="ui_qt/widgets/status_bar.py">
        <class name="StatusBar">
          <method name="__init__">初始化状态栏组件，设置UI和定时器</method>
          <method name="setup_ui">设置状态栏UI布局</method>
          <method name="show_message">显示状态消息</method>
          <method name="clear_message">清除状态消息</method>
          <method name="set_error_state">设置错误状态（红色，3秒后清除）</method>
          <method name="clear_error_state">清除错误状态</method>
          <method name="set_warning_state">设置警告状态（橙色，3秒后清除）</method>
          <method name="clear_warning_state">清除警告状态</method>
          <method name="set_success_state">设置成功状态（绿色，3秒后清除）</method>
          <method name="clear_success_state">清除成功状态</method>
          <method name="update_time">更新时间显示</method>
          <attribute name="status_label">主状态标签</attribute>
          <attribute name="message_timer">消息定时器</attribute>
        </class>
      </file>

      <file name="config_widget.py" path="ui_qt/widgets/config_widget.py">
        <class name="ConfigWidget">
          <method name="__init__">初始化配置管理界面</method>
          <method name="setup_ui">设置UI布局</method>
          <method name="load_current_config">加载当前配置到界面</method>
          <method name="update_config_from_ui">从界面更新配置</method>
          <method name="apply_config">应用配置</method>
          <method name="save_config">保存配置</method>
          <signal name="config_changed">配置变更信号</signal>
        </class>
      </file>

      <file name="config_manager.py" path="config_manager.py">
        <function name="save_config">保存配置到文件</function>
        <function name="load_config">从文件加载配置</function>
        <function name="get_user_config_path">获取用户配置文件路径</function>
        <function name="get_config_directory">获取跨平台配置目录</function>
      </file>
    </code>

    <dependencies>
      <package name="PySide6" version="6.8.0">Qt框架 - QTimer用于实现3秒自动清除</package>
      <package name="PySide6-Addons" version="6.8.0">Qt附加组件</package>
      <package name="langchain" version="0.3.27">AI集成框架</package>
      <package name="openai" version="1.106.1">OpenAI API</package>
      <package name="chromadb" version="1.0.20">向量数据库</package>
      <package name="sentence-transformers" version="5.1.0">文本嵌入模型</package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint name="架构约束">必须支持暗色和浅色两种主题</constraint>
    <constraint name="设计规范">遵循Material Design设计规范</constraint>
    <constraint name="可访问性">确保WCAG 2.1 AA级可访问性标准(对比度至少4.5:1)</constraint>
    <constraint name="集成约束">与Story 1.1和1.2建立的基础设施协同工作</constraint>
    <constraint name="状态持续时间">成功消息3秒后自动清除，错误消息保持显示直到下次操作</constraint>
    <constraint name="颜色方案">信息状态: 背景#e3f2fd, 文字#1976d2; 成功状态: 背景#e8f5e9, 文字#2e7d32; 错误状态: 背景#ffebee, 文字#c62828</constraint>
    <constraint name="消息管理">新状态消息立即替换当前消息，错误消息不会被自动清除的消息覆盖</constraint>
  </constraints>

  <interfaces>
    <interface name="QTimer" type="PySide6.QtCore">用于实现3秒自动清除定时器</interface>
    <interface name="QStatusBar" type="PySide6.QtWidgets">状态栏组件，提供状态反馈</interface>
    <interface name="save_config" type="function">config_manager.py中的配置保存函数</interface>
    <interface name="config_changed" type="signal">ConfigWidget发出的配置变更信号</interface>
    <interface name="set_info_state" type="method">status_bar.py中的信息状态设置方法</interface>
    <interface name="set_success_state" type="method">status_bar.py中的成功状态设置方法</interface>
    <interface name="set_error_state" type="method">status_bar.py中的错误状态设置方法</interface>
  </interfaces>

  <tests>
    <standards>
      <standard name="错误处理模式">使用try-except-finally模式，记录日志并显示用户友好的错误消息</standard>
      <standard name="日志记录模式">使用标准logging模块，区分INFO/DEBUG/WARNING/ERROR级别</standard>
      <standard name="状态反馈模式">成功消息3秒后自动清除，错误消息保持显示直到下次操作</standard>
      <standard name="颜色对比度测试">验证所有颜色组合满足WCAG 2.1 AA标准(对比度≥4.5:1)</standard>
      <standard name="主题兼容性测试">验证颜色方案在暗色和浅色主题下都有效</standard>
      <standard name="可访问性测试">颜色+图标+文字三重编码，确保色盲用户也能理解</standard>
    </standards>

    <locations>
      <location>ui_qt/widgets/status_bar.py - 状态反馈核心实现</location>
      <location>ui_qt/widgets/config_widget.py - 集成状态调用</location>
      <location>config_manager.py - 配置保存逻辑</location>
      <location>ui_qt/styles/material_dark.qss - 暗色主题样式</location>
      <location>ui_qt/styles/material_light.qss - 浅色主题样式</location>
    </locations>

    <ideas>
      <idea name="单元测试">为每个状态方法(set_info/success/error)编写单元测试</idea>
      <idea name="定时器测试">测试3秒自动清除功能的准确性</idea>
      <idea name="持久化测试">测试错误消息持久化显示逻辑</idea>
      <idea name="队列测试">测试状态消息队列管理，确保重要消息不丢失</idea>
      <idea name="集成测试">测试完整的配置修改→自动保存→状态反馈流程</idea>
      <idea name="主题测试">验证颜色方案在不同主题下的显示效果</idea>
      <idea name="对比度测试">使用工具验证颜色对比度符合WCAG标准</idea>
      <idea name="可访问性测试">测试色盲用户是否能通过图标和文字理解状态</idea>
    </ideas>
  </tests>
</story-context>