<story-context id="infinitequill-2025/bmm/workflows/4-implementation/story-context/2-2-dark-theme-role-list-fix" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2-2-dark-theme-role-list-fix</storyId>
    <title>暗色主题角色列表样式修复</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/abelxiaoxing/work/InfiniteQuill/docs/sprint-artifacts/2-2-dark-theme-role-list-fix.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>使用暗色模式的用户</asA>
    <iWant>角色列表的选中项有合适的颜色</iWant>
    <soThat>在夜间模式下能够清晰地看到选中的角色</soThat>
    <tasks>
      <task id="1" title="控件类型识别和样式分析" status="pending">
        <subtask>在role_manager.py中查找角色列表控件类型(QListWidget或QTableView)</subtask>
        <subtask>检查material_dark.qss文件中现有的列表项样式</subtask>
        <subtask>分析当前选中项的样式问题(白底白字)</subtask>
        <subtask>识别需要修改的QSS选择器</subtask>
        <subtask>测试悬停状态的现有实现</subtask>
      </task>
      <task id="2" title="QSS样式规则实现" status="pending">
        <subtask>在material_dark.qss中添加QListWidget::item:selected规则</subtask>
        <subtask>设置背景色为#3a3a3a</subtask>
        <subtask>设置文字颜色为#ffffff</subtask>
        <subtask>添加QListWidget::item:selected:hover规则(背景#4a4a4a)</subtask>
        <subtask>添加QListWidget::item:hover规则(悬停效果)</subtask>
        <subtask>如果是QTableView,添加对应的::item:selected和::item:hover规则</subtask>
        <subtask>移除或覆盖原有的白底样式</subtask>
      </task>
      <task id="3" title="WCAG对比度验证" status="pending">
        <subtask>使用对比度检测工具验证#3a3a3a与#ffffff的对比度</subtask>
        <subtask>确保比例≥4.5:1</subtask>
        <subtask>测试在不同显示器和亮度设置下的可读性</subtask>
        <subtask>如果对比度不足,调整颜色值并重新验证</subtask>
      </task>
      <task id="4" title="跨主题兼容性测试" status="pending">
        <subtask>切换到浅色模式,验证没有样式冲突</subtask>
        <subtask>确保material_light.qss不受暗色样式影响</subtask>
        <subtask>测试在两种主题间切换时的平滑过渡</subtask>
        <subtask>验证角色管理器内其他控件(按钮、输入框等)的样式一致性</subtask>
      </task>
      <task id="5" title="视觉回归测试" status="pending">
        <subtask>截取暗色模式下角色列表的截图</subtask>
        <subtask>验证选中项视觉样式符合设计</subtask>
        <subtask>测试不同角色数量下的显示效果</subtask>
        <subtask>验证滚动时选中项样式保持一致</subtask>
        <subtask>测试选中多个角色时的样式显示</subtask>
      </task>
      <task id="6" title="代码整理和文档化" status="pending">
        <subtask>在QSS文件中添加注释说明样式规则用途</subtask>
        <subtask>更新相关文档(如style guide)</subtask>
        <subtask>记录颜色值和设计决策</subtask>
        <subtask>代码审查和格式化</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <description>选中项背景色</description>
      <given>应用处于暗色模式</given>
      <when>从角色列表中选择任意角色时</when>
      <then>选中项的背景颜色应该显示为暗灰色(#3a3a3a), 与周围项有足够的视觉区分</then>
    </criterion>
    <criterion id="2">
      <description>选中项文字色</description>
      <given>角色项已被选中</given>
      <when>查看角色名字和详情文字时</when>
      <then>文字颜色应该为纯白色(#ffffff), 确保最佳的对比度和可读性</then>
    </criterion>
    <criterion id="3">
      <description>悬停状态反馈</description>
      <given>鼠标悬停在角色列表项上(无论是否选中)</given>
      <when>悬停时</when>
      <then>该项的背景色应该变为稍亮的灰色(#4a4a4a), 应该有清晰的视觉反馈表明该项可交互</then>
    </criterion>
    <criterion id="4">
      <description>WCAG对比度合规</description>
      <given>选中项显示暗灰色背景(#3a3a3a)和白色文字(#ffffff)</given>
      <when>计算对比度比例时</when>
      <then>应该满足WCAG 2.1 AA标准(至少4.5:1), 确保色盲用户也能清晰辨认</then>
    </criterion>
    <criterion id="5">
      <description>主题整体协调性</description>
      <given>暗色模式全局应用</given>
      <when>查看角色管理器所有UI元素时</when>
      <then>角色列表的选中样式应该与工具栏、按钮等其他暗色元素协调一致, 不应该出现突兀的视觉风格</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>docs/epics.md#Epic-2 - UI/UX体验优化</doc>
      <doc>docs/epics.md#Story-2.2 - 暗色主题角色列表样式修复</doc>
      <doc>docs/bmm-architecture-decisions-2025-11-16.md#需求4 - 架构决策文档</doc>
      <doc>Qt Style Sheets Reference - QSS样式表文档</doc>
      <doc>Material Design暗色模式规范</doc>
      <doc>WCAG 2.1对比度指南</doc>
      <doc>PySide6 QListWidget和QTableView文档</doc>
    </docs>
    <code>
      <file path="ui_qt/widgets/role_manager.py">
        <snippet line="196-218">
          <![CDATA[
        # 角色列表视图（显示详细信息）
        self.role_list = QListWidget()
        self.role_list.setObjectName("RoleListWidget")
        self.role_list.setSelectionMode(QListWidget.SingleSelection)
        self.role_list.itemClicked.connect(self.on_role_item_clicked)
        self.role_list.setStyleSheet(""
            QListWidget#RoleListWidget {
                border: none;
                background-color: transparent;
                outline: none;
            }
            QListWidget#RoleListWidget::item {
                padding: 12px;
                border-bottom: 1px solid #e0e0e0;
                margin: 0px;
            }
            QListWidget#RoleListWidget::item:hover {
                background-color: #f5f5f5;
            }
            QListWidget#RoleListWidget::item:selected {
                background-color: #e3f2fd;
                border-left: 4px solid #1976d2;
            }
        """)
          ]]>
        </snippet>
        <widget>
          <type>QListWidget</type>
          <objectName>RoleListWidget</objectName>
          <selectionMode>SingleSelection</selectionMode>
          <currentStyling>Light theme with blue selection</currentStyling>
        </widget>
      </file>
      <file path="ui_qt/utils/theme_manager.py">
        <snippet line="935-956">
          <![CDATA[
        /* ================ 角色列表样式 - 暗色主题 ================ */
        QListWidget#RoleListWidget {
            border: none;
            background-color: transparent;
            outline: none;
        }

        QListWidget#RoleListWidget::item {
            padding: 12px;
            border-bottom: 1px solid #555555;
            margin: 0px;
            color: #ffffff;
        }

        QListWidget#RoleListWidget::item:hover {
            background-color: #4a4a4a;
        }

        QListWidget#RoleListWidget::item:selected {
            background-color: #1e88e5;
            border-left: 4px solid #1976d2;
        }
          ]]>
        </snippet>
        <colorScheme>
          <background>#2d2d2d</background>
          <text>#ffffff</text>
          <hover>#4a4a4a</hover>
          <selected>#1e88e5</selected>
          <border>#555555</border>
        </colorScheme>
      </file>
    </code>
    <dependencies>
      <package name="PySide6" version="6.8.0">Qt框架</package>
      <package name="QSS">Qt样式表</package>
      <package name="Material Design">设计规范</package>
      <package name="WCAG 2.1">无障碍标准</package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="technical">
      <description>必须保持与浅色模式的样式隔离</description>
      <impact>确保暗色主题样式不会影响浅色模式</impact>
    </constraint>
    <constraint type="design">
      <description>遵循Material Design暗色模式规范</description>
      <impact>确保整体视觉风格一致性</impact>
    </constraint>
    <constraint type="accessibility">
      <description>确保悬停和选中状态有视觉层次</description>
      <impact>提供清晰的用户交互反馈</impact>
    </constraint>
    <constraint type="compatibility">
      <description>不影响其他暗色主题元素的样式</description>
      <impact>避免样式冲突和意外的视觉变化</impact>
    </constraint>
    <constraint type="performance">
      <description>使用相对颜色而非固定像素</description>
      <impact>确保在高DPI显示器上的正确显示</impact>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="ThemeManager">
      <description>主题管理器，负责加载和应用QSS样式</description>
      <method>apply_theme(window, theme_name: str)</method>
      <method>get_dark_theme() -> str</method>
      <method>get_current_theme() -> str</method>
    </interface>
    <interface name="QListWidget">
      <description>角色列表控件</description>
      <selector>QListWidget#RoleListWidget::item:selected</selector>
      <selector>QListWidget#RoleListWidget::item:hover</selector>
      <selector>QListWidget#RoleListWidget::item</selector>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard name="WCAG 2.1 AA">对比度比例≥4.5:1</standard>
      <standard name="Material Design">暗色模式设计规范</standard>
      <standard name="Qt Style Sheets">QSS语法和选择器规范</standard>
    </standards>
    <locations>
      <location>ui_qt/widgets/role_manager.py - 角色列表控件</location>
      <location>ui_qt/utils/theme_manager.py - 暗色主题样式</location>
      <location>ui_qt/styles/material_dark.qss - 暗色主题文件</location>
    </locations>
    <ideas>
      <test>对比度检测工具验证颜色组合</test>
      <test>不同显示器和亮度设置下的可读性测试</test>
      <test>主题切换时的平滑过渡测试</test>
      <test>角色数量变化对样式的影响测试</test>
      <test>滚动时选中项样式一致性测试</test>
      <test>多选情况下的样式显示测试</test>
    </ideas>
  </tests>
</story-context>