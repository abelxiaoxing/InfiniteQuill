<story-context id="1-1-project-setup-and-infrastructure-initialization" v="1.0">
  <metadata>
    <epicId>epic-1</epicId>
    <storyId>1-1</storyId>
    <title>项目设置与基础设施初始化</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-1-project-setup-and-infrastructure-initialization.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>开发团队</asA>
    <iWant>建立现代化的配置管理基础设施</iWant>
    <soThat>为所有后续功能提供可靠的配置基础</soThat>
    <tasks>
      <task id="1">分析现有config_widget.py的配置管理系统结构</task>
      <task id="2">设计2秒延迟自动保存机制的技术方案</task>
      <task id="3">在config_widget.py中添加变更监听机制框架</task>
      <task id="4">在status_bar.py中设计状态反馈接口</task>
      <task id="5">实现"配置已更改，2秒后自动保存..."状态消息</task>
      <task id="6">实现"配置已自动保存"成功消息</task>
      <task id="7">实现"配置保存失败，请重试"错误消息</task>
      <task id="8">在config_widget.py中实现closeEvent处理</task>
      <task id="9">添加活动定时器检查逻辑</task>
      <task id="10">实现立即保存机制</task>
      <task id="11">测试应用关闭时的数据完整性</task>
      <task id="12">将配置文件I/O操作移到后台线程</task>
      <task id="13">测试UI响应性和流畅度</task>
      <task id="14">验证自动保存过程中UI不卡顿</task>
      <task id="15">为自动保存机制编写单元测试</task>
      <task id="16">测试不同配置变更场景</task>
      <task id="17">验证错误处理逻辑</task>
      <task id="18">代码审查和格式化</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">配置保存机制支持 - Given 现有的配置管理系统, When 检查自动保存基础设施, Then 系统应该支持2秒延迟自动保存机制</criterion>
    <criterion id="2">状态反馈系统集成 - Given 配置变更触发自动保存, When 查看状态栏, Then 应该提供清晰的保存状态反馈</criterion>
    <criterion id="3">边界情况处理 - Given 应用正在关闭且有待保存的更改, When 关闭应用时, Then 应该立即触发自动保存以确保数据不丢失</criterion>
    <criterion id="4">性能优化 - Given 自动保存功能正在执行, When 检查UI响应性, Then 配置文件I/O应该在后台线程执行避免UI卡顿</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc name="epics.md" path="docs/epics.md" section="史诗1: 基础设施现代化">包含史诗1的完整故事分解</doc>
      <doc name="architecture-decisions" path="docs/bmm-architecture-decisions-2025-11-16.md" section="需求5: 配置管理无感（自动保存）">详细的架构决策和实现指导</doc>
      <doc name="component-inventory" path="docs/component-inventory.md">系统组件清单</doc>
      <doc name="development-guide" path="docs/development-guide.md">开发指南和模式</doc>
    </docs>

    <code>
      <file name="config_widget.py" path="ui_qt/widgets/config_widget.py">
        <class name="ConfigWidget">
          <method name="__init__">初始化配置管理界面</method>
          <method name="setup_ui">设置UI布局</method>
          <method name="load_current_config">加载当前配置到界面</method>
          <method name="update_config_from_ui">从界面更新配置</method>
          <method name="apply_config">应用配置</method>
          <method name="save_config">保存配置</method>
          <signal name="config_changed">配置变更信号</signal>
        </class>
      </file>

      <file name="status_bar.py" path="ui_qt/widgets/status_bar.py">
        <class name="StatusBar">
          <method name="show_message">显示状态消息</method>
          <method name="set_error_state">设置错误状态</method>
          <method name="set_warning_state">设置警告状态</method>
          <method name="set_success_state">设置成功状态</method>
          <method name="clear_message">清除状态消息</method>
          <method name="update_time">更新时间显示</method>
        </class>
      </file>

      <file name="config_manager.py" path="config_manager.py">
        <function name="save_config">保存配置到文件</function>
        <function name="load_config">从文件加载配置</function>
        <function name="get_user_config_path">获取用户配置文件路径</function>
        <function name="get_config_directory">获取跨平台配置目录</function>
      </file>
    </code>

    <dependencies>
      <package name="PySide6" version="6.8.0">Qt框架 - QTimer用于实现2秒延迟自动保存</package>
      <package name="PySide6-Addons" version="6.8.0">Qt附加组件</package>
      <package name="langchain" version="0.3.27">AI集成框架</package>
      <package name="openai" version="1.106.1">OpenAI API</package>
      <package name="chromadb" version="1.0.20">向量数据库</package>
      <package name="sentence-transformers" version="5.1.0">文本嵌入模型</package>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint name="架构约束">配置文件存储在跨平台目录（用户配置目录）</constraint>
    <constraint name="向后兼容">需要向后兼容现有配置格式</constraint>
    <constraint name="UI规范">遵循Material Design UI规范（状态栏样式）</constraint>
    <constraint name="性能约束">文件I/O必须在后台线程执行，避免UI阻塞</constraint>
    <constraint name="延迟机制">使用2秒延迟避免频繁I/O操作</constraint>
    <constraint name="状态反馈">使用三种状态：待保存(灰色)、成功(绿色)、错误(红色)</constraint>
  </constraints>

  <interfaces>
    <interface name="QTimer" type="PySide6.QtCore">用于实现2秒延迟自动保存机制</interface>
    <interface name="QStatusBar" type="PySide6.QtWidgets">状态栏组件，提供状态反馈</interface>
    <interface name="save_config" type="function">config_manager.py中的配置保存函数</interface>
    <interface name="config_changed" type="signal">ConfigWidget发出的配置变更信号</interface>
  </interfaces>

  <tests>
    <standards>
      <standard name="错误处理模式">使用try-except-finally模式，记录日志并显示用户友好的错误消息</standard>
      <standard name="日志记录模式">使用标准logging模块，区分INFO/DEBUG/WARNING/ERROR级别</standard>
      <standard name="状态反馈模式">成功消息3秒后自动清除，错误消息保持显示直到下次操作</standard>
      <standard name="性能测试">验证自动保存过程中UI响应性，不应出现卡顿</standard>
      <standard name="边界测试">测试应用关闭时的数据保存完整性</standard>
    </standards>

    <locations>
      <location>ui_qt/widgets/config_widget.py - 自动保存核心逻辑</location>
      <location>ui_qt/widgets/status_bar.py - 状态反馈接口</location>
      <location>config_manager.py - 配置保存逻辑</location>
    </locations>

    <ideas>
      <idea name="单元测试">为自动保存机制编写单元测试，验证2秒延迟逻辑</idea>
      <idea name="集成测试">测试配置变更到状态反馈的完整流程</idea>
      <idea name="边界测试">测试应用关闭时自动保存的数据完整性</idea>
      <idea name="性能测试">验证后台线程I/O操作不阻塞UI</idea>
      <idea name="错误测试">测试保存失败时的错误处理和用户反馈</idea>
    </ideas>
  </tests>
</story-context>